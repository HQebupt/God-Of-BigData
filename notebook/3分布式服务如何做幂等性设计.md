## 为什么需要保证幂等性

编程中的“幂等性”是指任意多次执行所产生的影响，与一次执行的影响相同。一个拥有幂等性设计的接口，保证无论一次或多次来调用接口，都能够得到相同的结果。

> 接口的幂等性设计在某些场景下是必需的，例如用户下单的场景。

服务之间的调用存在三种状态：成功、失败、超时。超时是一种未知的状态：被调服务是否执行成功，这个状态是未知的。上游服务调用下游服务超时时可能会进行重试。



对于用户下单的场景的超时重试我们考虑以下问题：

- 是否会导致最终创建了两条一样的订单？
- 是否会扣除两遍库存？
- 是否会重复扣除用户的钱？

如果每一笔订单都携带唯一的序号，下单接口可以借助这个序号，来记录某次下单操作的状态。当下单的状态为成功时，就将重复的执行拦截住，避免出现上述的问题。这种方式是由下游被调方来保证幂等性。

除此之外，订单服务也可以提供查询订单状态的接口，上游在下单之前先进行查询，确认该笔订单并没有成功支付后，再重复进行下单操作。

> 一般来说，服务本身需要自己保证幂等性，而不应该将幂等性交给上游的调用方来做。