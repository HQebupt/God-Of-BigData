## 0背景是什么，要解决什么问题？

Loris从单体应用，要改造成分布式应用，提升它的吞吐量和稳定性。有一个功能点是Reservation Service，需要去第3方service预定资源，定一个时间段。最理想的情况就是用户在loris预定的时候，第三方资源也是可用的，直接预定成功。

现实的情况是：这个资源当前是被占用的，需要等到它释放之后，新用户才可以预定。抽象出问题就是如何定时执行一些任务。

在互联网应用场景中，也有很多应用，比如营销活动定时生效、定时更新数据、定时取消营销活动。

>  解决方案是什么？从两个角度来考虑：单机架构和分布式架构。

![image-20210528203635514](3如何进行分布式任务调度框架选型.assets/image-20210528203635514-1622205398609.png)

## 1 单机的情况-最小堆实现方案

- 单线程—Timer实现
  - 好处就是简单，是单线程+最小堆的实现方案。不足有2点：①线程只有1个，不灵活；②线程出错，就完了。
  - 最小堆的内部实现类是TaskQueue
- 多线程方案-ScheduledThreadPoolExecutor
  - 好处就是解决了Timer的不足
  - 自定义延迟队列DelayedWorkQueue，本质也是最小堆

最小堆的取出poll和插入put的时间效率都是O(logN)，因为需要堆调整。

* 时间轮（RingBufferWheel)
  * 解决最小堆的效率，时间换空间，怎么做到保证有序的情况下，插入和取出都是O(1)。只能借助Hash的思想来实现。（具体TODO: 有没有应用场景）

## 2 分布式方案

要求是什么？可扩展、高可用，性能放在最后考虑。

> 题外话，DRI 有2个问题，
>
> 1. 同时预定怎么办？分布式锁？秒杀的实现？
>
> 2. 当A占用资源的时候，B如何做到预定未来的一段时间，甚至是B\C\D多个人如何做到预定未来的一段时间？

#### 2.1 quartz

它的分布式调度策略是以数据库为边界的一种异步策略。各个调度器都遵守一个**基于数据库锁的操作规则**从而保证了操作的唯一性，同时多个节点的异步运行保证了服务的可靠。（实际上是用数据库锁作为分布式锁解决同步问题实现异步运行，跟redis、zk做分布式锁时是一样的）

- 好处：实现简单
- 局限性：依赖数据库锁，如果大量的短任务同时来，各个quartz节点都会抢占**数据库锁**，竞争加剧，线程必然大量等待，上下文切换就多了。（白话：同一时间点，有很多段任务同时进行调度，都会去争抢数据库锁，导致竞争加剧。）

> Loris只有几千的并发量，所以就这样做的。把quartz集成到Reservation service里面去，可以实现3台，并且支持2000左右的任务并发量。

## 3 选型的方案的几条原则
1. 业务起步阶段：没有自主研发运维能力，选择业界使用最多最成熟的，最好是直接买，比如阿里云的Schedulerx2.0，只开发业务逻辑即可；或者Elastic-job-cloud版本，在私有云上部署，功能支持也比较完善，花钱都能解决
2. **业务发展阶段**：数据规模和任务规模都在扩大，有一定的研发能力，可以考虑接入成熟开源框架，比如quartz或者Elastic-job-lite都是开源的，几台机器搭建起来就可以跑，出问题了开源用解答的也比较多。**每秒几千个任务没问题**
3. 业务成熟阶段：每秒任务扩大到几万、几十万个，而且业务个性化需要越来越多，比如各种调度策略，批处理任务的个性化支持，这时候要选择一个开源框架的基础上进行二次开发，目前quartz或者Elastic-job-lite都是不错的选择





参考：[谈谈定时任务解决方案原理](https://www.jianshu.com/p/84d9db1b1def)